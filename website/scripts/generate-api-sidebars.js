#!/usr/bin/env node
//
// Licensed to the Apache Software Foundation (ASF) under one or more
// contributor license agreements.  See the NOTICE file distributed with
// this work for additional information regarding copyright ownership.
// The ASF licenses this file to You under the Apache License, Version 2.0
//
// Reads api_module_list.txt (Python) and docs/api/rust/crates.txt (Rust),
// writes sidebars-api.generated.ts with API Reference sidebar items.
// Run from repo root or website/ (e.g. npm run prebuild).
//

const fs = require('fs');
const path = require('path');

const REPO_ROOT = path.resolve(__dirname, '..', '..');
const API_MODULE_LIST = path.join(REPO_ROOT, 'docs', 'sphinx', 'source', 'api_module_list.txt');
const RUST_CRATES_LIST = path.join(REPO_ROOT, 'docs', 'api', 'rust', 'crates.txt');
const OUT_FILE = path.join(__dirname, '..', 'sidebars-api.generated.ts');

const DEFAULT_PYTHON_ITEMS = ['api/python/index', 'api/python/qumat', 'api/python/qumat.qdp'];
const DEFAULT_RUST_ITEMS = ['api/rust/qdp-core'];

function readLines(filePath) {
  if (!fs.existsSync(filePath)) return null;
  const content = fs.readFileSync(filePath, 'utf8');
  return content
    .split('\n')
    .map((s) => s.trim())
    .filter((s) => s.length > 0 && !s.startsWith('#'));
}

function main() {
  let pythonDocIds = readLines(API_MODULE_LIST);
  if (pythonDocIds === null || pythonDocIds.length === 0) {
    pythonDocIds = DEFAULT_PYTHON_ITEMS.slice();
  }
  // api_module_list.txt has "api/python/..." ids; index is the category link, rest are children
  const pythonIndex = 'api/python/index';
  const pythonChildren = pythonDocIds.filter((id) => id !== pythonIndex);

  let rustDocIds = readLines(RUST_CRATES_LIST);
  if (rustDocIds === null || rustDocIds.length === 0) {
    rustDocIds = DEFAULT_RUST_ITEMS.slice();
  } else {
    rustDocIds = rustDocIds.map((crate) => 'api/rust/' + crate);
  }

  const pythonCategory = {
    type: 'category',
    label: 'Python API',
    collapsed: false,
    link: { type: 'doc', id: pythonIndex },
    items: pythonChildren,
  };
  const rustCategory = {
    type: 'category',
    label: 'Rust API',
    collapsed: false,
    link: rustDocIds.length > 0 ? { type: 'doc', id: rustDocIds[0] } : undefined,
    items: rustDocIds,
  };

  const items = [pythonCategory, rustCategory];
  const ts = `// Generated by website/scripts/generate-api-sidebars.js - do not edit manually
import type {SidebarsConfig} from '@docusaurus/plugin-content-docs';

export const apiSidebarItems: SidebarsConfig['docsSidebar'] = ${JSON.stringify(items, null, 2)};
`;

  fs.writeFileSync(OUT_FILE, ts, 'utf8');
  console.log('Wrote', path.relative(REPO_ROOT, OUT_FILE), '(Python API + Rust API categories)');
}

main();
