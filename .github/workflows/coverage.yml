#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: Coverage

on:
  push:
    branches: [main]
    paths:
      - "**.py"
      - "**/*.rs"
      - "pyproject.toml"
      - "qdp/**/Cargo.toml"
      - ".github/workflows/coverage.yml"
  pull_request:
    branches: [main]
    paths:
      - "**.py"
      - "**/*.rs"
      - "pyproject.toml"
      - "qdp/**/Cargo.toml"
      - ".github/workflows/coverage.yml"
  workflow_dispatch:

jobs:
  python-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run tests with coverage
        run: uv run pytest testing/ -v --cov=qumat --cov-report=xml --cov-report=term

      - uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: coverage.xml

  # Requires GPU/CUDA
  rust-coverage:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install llvm-tools
        run: rustup component add llvm-tools-preview

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov

      - name: Run Rust tests with coverage
        working-directory: qdp
        run: cargo llvm-cov test --workspace --exclude qdp-python --lcov --output-path lcov.info

      - uses: actions/upload-artifact@v4
        with:
          name: rust-coverage
          path: qdp/lcov.info

  codecov:
    runs-on: ubuntu-latest
    needs: [python-coverage, rust-coverage]
    steps:
      - uses: actions/checkout@v6

      - name: Download Python coverage
        uses: actions/download-artifact@v4
        with:
          name: python-coverage

      - name: Download Rust coverage (optional; absent when no GPU)
        uses: actions/download-artifact@v4
        with:
          name: rust-coverage
          path: .
        continue-on-error: true

      - name: Set coverage files for Codecov
        id: files
        run: |
          FILES="coverage.xml"
          if [ -f qdp/lcov.info ]; then FILES="coverage.xml,qdp/lcov.info"; fi
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ${{ steps.files.outputs.files }}
          fail_ci_if_error: false
